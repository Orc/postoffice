CC=@CC@
CFLAGS=@CFLAGS@
LDFLAGS=@LDFLAGS@

PGMS = postoffice dbm expire
TOOLS = mx b64 getopt
MAN8PAGES=postoffice.8 authexpire.8 sendmail.8 smtpd.8
MAN7PAGES=mailaddr.7 greylist.7
VMAN7PAGES=vhosts.7
MAN5PAGES=aliases.5 smtpauth.5 mailaudit.5 postoffice.cf.5
VMAN5PAGES=domains.cf.5
MAN1PAGES=newaliases.1 mailq.1 runq.1

MANPAGES=$(MAN8PAGES) $(MAN7PAGES) $(MAN5PAGES) $(MAN1PAGES) \
	 $(VMAN5PAGES) $(VMAN7PAGES)

prefix=@prefix@
libdir=@libdir@
libexec=@libexec@
bindir=@exedir@
sbindir=@sbindir@
mandir=@mandir@

@AUTHMK@AUTH_OBJS= auth.o b64.o

OBJS=server.o letter.o smtp.o addr.o getif.o getloadavg.o \
     mx.o userok.o address.o spool.o recipient.o listq.o \
     mail.o local.o virusscan.o greylist.o runq.o mapfd.o \
     config.o remote.o mbox.o bounce.o postoffice.o \
     newaliases.o arpatok.o audit.o goodness.o domain.o \
     dbif.o getopt.o $(AUTH_OBJS) @MILTERLIB@


all: $(PGMS)

postoffice: $(OBJS)
	$(CC) $(CFLAGS) -o postoffice $(OBJS) @LIBS@ @LIBWRAP@ @LIBCRYPT@

postoffice.o: postoffice.c config.h letter.h env.h smtp.h VERSION
	$(CC) $(CFLAGS) -c postoffice.c -DVERSION=\"`cat VERSION`\"

expire:	expire.c dbif.o
	$(CC) $(CFLAGS) -o expire expire.c dbif.o @LIBS@

dbm:	dbm.c dbif.o
	$(CC) $(CFLAGS) -o dbm dbm.c dbif.o @LIBS@

tools:  $(TOOLS)

mx:     mx.c
	$(CC) $(CFLAGS) -DDEBUG=1 -o mx mx.c @LIBS@

b64:    b64.c
	$(CC) $(CFLAGS) -DDEBUG=1 -o b64 b64.c

getopt: getopt.c
	$(CC) $(CFLAGS) -DDEBUG=1 -o getopt getopt.c

install: install.@WHICH@ install.man


install.man: $(MANPAGES)
	@INSTALL_DIR@ $(TARGET)$(mandir)/man8
	@INSTALL_DIR@ $(TARGET)$(mandir)/man7
	@INSTALL_DIR@ $(TARGET)$(mandir)/man5
	@INSTALL_DIR@ $(TARGET)$(mandir)/man1
	@INSTALL_DATA@ -m 444 -c $(MAN8PAGES) $(TARGET)$(mandir)/man8
	@INSTALL_DATA@ -m 444 -c $(MAN7PAGES) $(TARGET)$(mandir)/man7
	if test "@VPATH@";then @INSTALL_DATA@ -m 444 -c $(VMAN7PAGES) $(TARGET)$(mandir)/man7; fi
	@INSTALL_DATA@ -m 444 -c $(MAN5PAGES) $(TARGET)$(mandir)/man5
	if test "@VPATH@";then @INSTALL_DATA@ -m 444 -c $(VMAN5PAGES) $(TARGET)$(mandir)/man5; fi
	@INSTALL_DATA@ -m 444 -c $(MAN1PAGES) $(TARGET)$(mandir)/man1
	@INSTALL_DATA@ -m 444 -c dbm.1 $(TARGET)$(mandir)/man1/@NDBM@.1

install.common.binaries:
	@INSTALL_DIR@ $(TARGET)$(libexec)
	@INSTALL_DIR@ $(TARGET)$(bindir)
	@INSTALL_PROGRAM@ -c expire $(TARGET)$(libexec)/authexpire
	@INSTALL_PROGRAM@ -c dbm $(TARGET)$(bindir)/@NDBM@

install.programs: $(PGMS) install.common.binaries
	@INSTALL_DIR@ $(TARGET)$(libdir)
	@INSTALL@ -m 4711 -c postoffice $(TARGET)$(libdir)
	@INSTALL_DIR@ $(TARGET)$(bindir)
	@INSTALL_DIR@ $(TARGET)$(sbindir)
	for x in runq mailq newaliases sendmail; do \
	    rm -f $(TARGET)$(bindir)/$$x; \
	    ln -s $(libdir)/postoffice $(TARGET)$(bindir)/$$x; \
	done
	for x in sendmail smtpd; do \
	    rm -f $(TARGET)$(sbindir)/$$x; \
	    ln -s $(libdir)/postoffice $(TARGET)$(sbindir)/$$x; \
	done
	rm -f $(TARGET)$(libdir)/sendmail
	ln -s $(libdir)/postoffice $(TARGET)$(libdir)/sendmail

install.mailfilter: $(PGMS) install.common.binaries
	@INSTALL_DIR@ $(TARGET)$(libexec)
	@INSTALL_DIR@ $(TARGET)$(bindir)
	@INSTALL@ -m 4711 -c postoffice $(TARGET)$(libexec)
	ln -fs @MAILWRAPPER@ $(TARGET)$(bindir)/runq
	echo "# emulate sendmail with postoffice" > $(TARGET)@MAILERCONF@.new
	for x in sendmail send-mail mailq newaliases runq; do \
	    echo "$$x	$(libexec)/postoffice"; \
	done >> $(TARGET)@MAILERCONF@.new
	cp -f $(TARGET)@MAILERCONF@ $(TARGET)@MAILERCONF@.old
	mv $(TARGET)@MAILERCONF@.new $(TARGET)@MAILERCONF@

clean:
	rm -f *.o $(PGMS) $(TOOLS)

distclean spotless: clean
	rm -f @GENERATED_FILES@ @CONFIGURE_FILES@

addr.o: addr.c
address.o: address.c config.h letter.h env.h domain.h mx.h
arpatok.o: arpatok.c
audit.o: audit.c env.h letter.h domain.h
auth.o: auth.c config.h letter.h env.h domain.h dbif.h
b64.o: b64.c
bounce.o: bounce.c config.h letter.h env.h domain.h mbox.h bounce.h
config.o: config.c config.h env.h
dbif.o: dbif.c dbif.h config.h
dbm.o: dbm.c config.h dbif.h
domain.o: domain.c config.h letter.h env.h domain.h
expire.o: expire.c dbif.h config.h
getif.o: getif.c config.h
getloadavg.o: getloadavg.c
goodness.o: goodness.c config.h dbif.h letter.h env.h domain.h
greylist.o: greylist.c config.h letter.h env.h domain.h dbif.h
letter.o: letter.c config.h letter.h env.h domain.h mx.h spool.h
listq.o: listq.c config.h spool.h letter.h env.h domain.h
local.o: local.c config.h letter.h env.h domain.h
mail.o: mail.c config.h letter.h env.h domain.h
mapfd.o: mapfd.c
mbox.o: mbox.c config.h mbox.h env.h mx.h
mx.o: mx.c config.h mx.h
newaliases.o: newaliases.c config.h dbif.h aliases.h env.h domain.h
ns.o: ns.c
postoffice.o: postoffice.c config.h letter.h env.h domain.h smtp.h
recipient.o: recipient.c config.h letter.h env.h domain.h
remote.o: remote.c config.h letter.h env.h domain.h mbox.h bounce.h
runq.o: runq.c config.h spool.h letter.h env.h domain.h bounce.h
server.o: server.c config.h letter.h env.h domain.h smtp.h mx.h
smtp.o: smtp.c config.h letter.h env.h domain.h smtp.h mx.h
spool.o: spool.c config.h spool.h letter.h env.h domain.h mx.h
userok.o: userok.c config.h letter.h env.h domain.h dbif.h
virusscan.o: virusscan.c config.h letter.h env.h domain.h
